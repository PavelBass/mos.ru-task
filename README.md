# some company Job challenge

## Задание

Реализовать асинхронный HTTP-сервер, обрабатывающий поисковые запросы пользователей.

Работа сервиса описывается так:

1. Сервис принимает текстовый запрос пользователя.
2. Определяет, к какой теме или темам может принадлежать запрос (подробности см. ниже).
3. Выдает результат в формате json, в котором указан список соответствущих запросу тем.

Каждая тема определяется набором фраз, например:

- новости: "деревья на Садовом кольце", "добрый автобус", "выставка IT-технологий";
- кухня: "рецепт борща", "яблочный пирог", "тайская кухня";
- товары: "Дети капитана Гранта", "зимние шины", "Тайская кухня";

или любые другие, на ваше усмотрение. Важно, чтобы какая-то из фраз встретилась в нескольких наборах индексов, как "тайская кухня" в примере.
Предполагается, что наборы фраз все умещаются в оперативной памяти, но при этом могут быть достаточно большими.

Правило принадлежности запроса теме:

1. Если набор слов из запроса содержит в себе все слова какой-либо из фраз, то запрос считается соответствующим теме. Иначе - не соответствующим.
2. Порядок слов в запросе и во фразах не учитывается.

Примеры:

Запрос "где купить зимние шины" соответствует теме "товары", т.к. содержит в себе все слова из фразы "зимние шины".
Запрос "борща любимого рецепт" соответствует теме "кухня", т.к. содержит в себе все слова из фразы "рецепт борща".
Запрос "тайская кухня" соответствует двум темам: "кухня" и "товары".
Запрос "кухня" не соответствует ни одной теме, т.к. не включает в себя целиком слова ни одной из фраз.

## Реализация

Сервис реализован на Python 3.7 с использованием библиотек asyncio и aiohttp.

### Запуск сервиса

Создайте виртуальное окружение с Python 3.7 и выше и активируйте его. Далее для установки:
```pip install git+https://github.com/PavelBass/secrecompany-task.git```

Для запуска исползуйте команду:
```mosru_task run```

Сервис запустится по адресу 0.0.0.0 на порту 8000, для изменения IP адреса и порта, используйте соответсвтующие параметры, например:
```mosru_task run --host 127.1 --port 9999```

### Запуск тестов

Склонируйте проект:
```git clone https://github.com/PavelBass/secret-company-task```

Перейдите в папку с проектом:
```cd secret-company-task```

Установите необходимые для тестирования библиотеки (лучше использовать виртуальное окружение):
```pip install git+https://github.com/PavelBass/secret-company-task[test]```

Запустите тесты:
```pytest```

### API

Поисковый url сервиса находится по адресу `HOST:PORT/search/`, по умолчанию на `0.0.0.0:8000/search`. Апи принимает
GET запросы c параметром `q` (query).

Для тестирования API можно использовать брауез, либо консольные утилиты, такие как curl, httpie и т.п. Например, используя консольную утилиту httpie:

```
~$ http 0.0.0.0:8000/search/?q="тайская кухня"
HTTP/1.1 200 OK
Content-Length: 230
Content-Type: application/json; charset=utf-8
Date: Sat, 29 Dec 2018 11:57:13 GMT
Server: Python/3.7 aiohttp/3.5.1

{
    "data": {
        "query": "тайская кухня",
        "themes": [
            "товары",
            "кухня"
        ]
    },
    "status": {
        "name": "Ok",
        "value": "Found relevant data"
    }
}

~$ http 0.0.0.0:8000/search/?q="кухня"
HTTP/1.1 200 OK
Content-Length: 129
Content-Type: application/json; charset=utf-8
Date: Sat, 29 Dec 2018 11:58:11 GMT
Server: Python/3.7 aiohttp/3.5.1

{
    "data": {
        "query": "кухня",
        "themes": []
    },
    "status": {
        "name": "NoResult",
        "value": "No result for passed query"
    }
}
```

### Особенности реализации

Бизнес-логика реализована в сервисах `Service` и отделена от транспортного уровня (Handler) и математических вычислений, которые обусловлены хранением и обработкой данных. `SearchService` формирует набор данных для поискового запроса, используя инструменты tools или другие сервисы. В текущей реализации он подбирает только набор релевантных тем.

Тип `Theme` представляет собой тему с набором определяющей её фраз, умеющий определять подходит ли переданная фраза теме.

`ThemesKeeper` это инструмент управления набором тем, он хранит набор тем `Theme`, предоставляет интерфейс для управления набором (добавление и удаление) и инкапсулирует метод, который для переданной фразы выберет все темы, которые считают, что переданная фраза релеванна.

Хендлеры не должны содержать никакой бизнес-логики, это "транспортный" уровень, который обеспечивает перенос HTTP запроса в вызов методов сервисов и перенос ответа от сервисов в HTTP ответ.

`PeriodicTask` это фоновые задачи, которые запускаются с постоянной периодичностью. Это инициаторы действия (сервисов), работающие по таймеру, а не по запросам пользователей. В текущей раелизации список актуальных тем предложено обновлять периодически с помощью `ProcessNewPricesPeriodicTask`, который запускает бинес логику обновления тем в `ThemesService`

`Repository` предоставляют интерфейс для доступа к данным, хранящихся во внешних источниках или в памяти.
